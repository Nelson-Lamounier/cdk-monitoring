apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "monitoring.fullLabels" "prometheus" | nindent 4 }}
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.prometheus.scrapeInterval }}
      evaluation_interval: {{ .Values.prometheus.scrapeInterval }}

    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets: ["localhost:9090"]

      - job_name: kubernetes-nodes
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        authorization:
          credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

      - job_name: kubernetes-cadvisor
        scheme: https
        metrics_path: /metrics/cadvisor
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        authorization:
          credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
          - role: node

      - job_name: kubernetes-service-endpoints
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: "true"
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+)
            replacement: ${1}
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_service_name]
            target_label: service
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: node-exporter
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names: [{{ .Values.namespace }}]
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: node-exporter

      - job_name: kube-state-metrics
        static_configs:
          - targets: ["kube-state-metrics.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.kubeStateMetrics.service.port }}"]

      - job_name: grafana
        static_configs:
          - targets: ["grafana.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.grafana.service.port }}"]

      - job_name: loki
        static_configs:
          - targets: ["loki.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.loki.service.port }}"]

      - job_name: tempo
        static_configs:
          - targets: ["tempo.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.tempo.service.httpPort }}"]

      - job_name: github-actions-exporter
        static_configs:
          - targets: ["github-actions-exporter.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.githubActionsExporter.service.port }}"]

      - job_name: traefik
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [kube-system]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: traefik
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: ${1}:9100
