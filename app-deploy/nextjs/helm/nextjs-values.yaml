# @format
# Next.js Helm Values — Multi-Node HA Topology
#
# Overrides the default chart values to spread Next.js pods across
# Kubernetes worker nodes for high availability and resilience.
#
# Flow:
#   1. Git: Commit a change here (e.g., replicas 2 → 3)
#   2. Sync Pipeline: GitHub Actions pushes to S3 scripts bucket
#   3. Deploy Pipeline: SSM triggers deploy-manifests.sh on the control plane
#   4. EC2 Execution: helm upgrade --install reads this file from S3
#   5. K8s Convergence: Scheduler spreads pods per anti-affinity rules
#
# Install (on EC2 control plane):
#   helm upgrade --install nextjs-topology ./chart \
#     -n nextjs-app -f nextjs-values.yaml --wait

# ---------------------------------------------------------------------------
# Replica Count
#
# Number of Next.js pods. With 3 worker nodes, 2 replicas gives N+1
# redundancy. Scale to 3 for full node coverage.
# ---------------------------------------------------------------------------
replicaCount: 2

# ---------------------------------------------------------------------------
# Pod Anti-Affinity — Spread Across Nodes
#
# preferredDuringSchedulingIgnoredDuringExecution ensures the scheduler
# tries to place pods on different nodes, but won't block scheduling
# if only one node is available (graceful degradation).
# ---------------------------------------------------------------------------
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - nextjs
          topologyKey: kubernetes.io/hostname

# ---------------------------------------------------------------------------
# Topology Spread Constraints — Even Distribution
#
# Distributes pods evenly across nodes. maxSkew=1 means no node should
# have more than 1 extra pod compared to the least-loaded node.
# whenUnsatisfiable: ScheduleAnyway allows scheduling even if perfect
# balance can't be achieved (e.g., during scale-up).
# ---------------------------------------------------------------------------
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app: nextjs

# ---------------------------------------------------------------------------
# Tolerations
#
# No special tolerations needed — Next.js runs on worker nodes only.
# Control plane taint is already removed by boot-k8s.sh for our
# single control-plane setup.
# ---------------------------------------------------------------------------
tolerations: []
