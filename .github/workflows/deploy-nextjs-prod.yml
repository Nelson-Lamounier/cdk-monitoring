# Deploy NextJS Application to Production
# Manual trigger only with approval gate
# Uses shared VPC from Monitoring project// test

name: Deploy NextJS to Production

on:
  push:
    branches:
      - main
    paths:
      - "lib/stacks/nextjs/**"
      - "lib/projects/nextjs/**"
      - "lib/common/**"
      - "bin/app.ts"
      - ".github/workflows/_deploy-nextjs.yml"
      - ".github/workflows/deploy-nextjs-prod.yml"
  workflow_dispatch:
    inputs:
      confirm-deployment:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string
      skip-staging-check:
        description: "Skip staging verification check (emergency only)"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}

    steps:
      - name: Validate Confirmation
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.confirm-deployment }}" != "DEPLOY" ]; then
              echo "ERROR: Deployment not confirmed. Type 'DEPLOY' to proceed."
              exit 1
            fi
            echo "✓ Deployment confirmed (manual trigger)"
          else
            echo "✓ Automatic deployment via push to main"
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Check Staging Status
        if: github.event_name == 'push' || inputs.skip-staging-check != true
        run: |
          echo "Verifying staging deployment was successful..."
          # In a full implementation, this would check the latest staging run
          echo "✓ Staging check passed (manual verification required)"

  # ===========================================================================
  # Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    needs: [preflight]
    if: needs.preflight.outputs.proceed == 'true'
    uses: ./.github/workflows/_deploy-nextjs.yml
    with:
      environment: production
      cdk-environment: production
      require-approval: never
      enable-security-scan: true
      security-scan-blocking: true
      skip-verification: false
      # domain-name, hosted-zone-id, cross-account-role-arn are resolved from
      # environment-scoped variables inside the reusable workflow (not repository vars)
    secrets: inherit

  # ===========================================================================
  # Post-Deploy Notification
  # ===========================================================================
  notify:
    name: Notify
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "## ✅ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "NextJS application has been deployed to production." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the deployment logs for details." >> $GITHUB_STEP_SUMMARY
          fi
