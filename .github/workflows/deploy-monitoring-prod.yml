# @format
# @description Deploy Monitoring to Production - Uses immutable artifacts from staging

name: Deploy Monitoring to Production

on:
  push:
    branches:
      - main
    paths:
      # Monitoring-specific
      - "lib/stacks/monitoring/**"
      - "lib/projects/monitoring/**"
      - "lib/config/monitoring/**"
      - "scripts/monitoring/**"
      # Shared infrastructure (used by monitoring constructs)
      - "lib/config/*.ts"
      - "lib/common/**"
      - "lib/factories/**"
      - "lib/aspects/**"
      - "lib/shared/**"
      - "lib/utilities/**"
      - "bin/app.ts"
      # Workflow files
      - ".github/workflows/deploy-monitoring-prod.yml"
      - ".github/workflows/_deploy-monitoring.yml"
      - ".github/workflows/_deploy-stack.yml"
      - ".github/workflows/_verify-stack.yml"
      - ".github/actions/**"
  workflow_dispatch:
    inputs:
      staging_run_id:
        description: "Staging workflow run ID to deploy (leave empty for latest)"
        type: string
        required: false
      force_resynthesis:
        description: "Force re-synthesis (bypasses immutable artifact)"
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  actions: read

concurrency:
  group: deploy-monitoring-production
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Pre-Flight: Retrieve Staging Artifact
  # ===========================================================================
  preflight:
    name: Pre-Flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      staging-artifact-found: ${{ steps.artifact.outputs.found }}
      staging-run-id: ${{ steps.artifact.outputs.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Locate Staging Artifact
        id: artifact
        if: inputs.force_resynthesis != true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.staging_run_id }}" ]; then
            STAGING_RUN_ID="${{ inputs.staging_run_id }}"
          else
            STAGING_RUN_ID=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/deploy-monitoring-staging.yml/runs?status=success&per_page=1" \
              --jq '.workflow_runs[0].id' 2>/dev/null || echo "")

            if [ -z "$STAGING_RUN_ID" ] || [ "$STAGING_RUN_ID" == "null" ]; then
              echo "WARNING: No successful staging deployment found"
              echo "found=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          ARTIFACTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs/$STAGING_RUN_ID/artifacts" \
            --jq '.artifacts[] | select(.name | startswith("cdk-out-production-ready-")) | .name' 2>/dev/null || echo "")

          if [ -n "$ARTIFACTS" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "run_id=$STAGING_RUN_ID" >> $GITHUB_OUTPUT
            echo "Found staging artifact from run: $STAGING_RUN_ID"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No production-ready artifact found"
          fi

      - name: Download Staging Artifact
        if: steps.artifact.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh run download ${{ steps.artifact.outputs.run_id }} \
            -p "cdk-out-production-ready-*" \
            -D staging-artifact

          if [ -f "staging-artifact/production-readiness.json" ]; then
            echo "✓ Production readiness verified"
          else
            echo "⚠ Production readiness file not found"
          fi

  # ===========================================================================
  # Deploy Using Reusable Workflow
  # ===========================================================================
  deploy:
    name: Deploy to Production
    needs: preflight
    uses: ./.github/workflows/_deploy-monitoring.yml
    with:
      environment: production
      cdk-environment: production
      require-approval: never
      enable-security-scan: true
      security-scan-blocking: true
      skip-verification: false
      create-production-artifact: false
    secrets:
      AWS_OIDC_ROLE: ${{ secrets.AWS_OIDC_ROLE }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}

  # ===========================================================================
  # Audit Trail
  # ===========================================================================
  audit:
    name: Create Audit Trail
    needs: [preflight, deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      - name: Generate Audit Record
        run: |
          cat > audit-record.json << EOF
          {
            "deploymentId": "${{ github.run_id }}-$(date -u '+%Y%m%d%H%M%S')",
            "environment": "production",
            "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "triggeredBy": "${{ github.actor }}",
            "stagingRunId": "${{ needs.preflight.outputs.staging-run-id }}",
            "commitSha": "${{ github.sha }}",
            "deploymentResult": "${{ needs.deploy.result }}"
          }
          EOF

          cat audit-record.json

      - name: Upload Audit Trail
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: production-audit-${{ github.run_number }}
          path: audit-record.json
          retention-days: 365
