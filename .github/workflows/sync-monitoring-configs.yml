# @format
# @description Sync Monitoring Configs (Production)
# Syncs all monitoring configuration files (dashboards, Prometheus, Loki,
# Promtail, Tempo, Grafana provisioning) to S3 and triggers intelligent
# per-service reloads via SSM â€” no full CDK deploy needed.
#
# Reload strategy:
#   - Dashboards:           Grafana auto-detects (~30s), no restart
#   - Prometheus:           Hot-reload via lifecycle API (zero downtime)
#   - Grafana provisioning: docker restart grafana
#   - Loki/Promtail/Tempo:  docker restart <service>
#   - docker-compose.yml:   docker compose up -d (recreates changed only)
#
# Trigger: Manual dispatch only (production environment)

name: Sync Monitoring Configs

on:
  workflow_dispatch:
    inputs:
      confirm-sync:
        description: 'Type "SYNC" to confirm production config sync'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: sync-monitoring-production
  cancel-in-progress: false

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}

jobs:
  # ===========================================================================
  # Pre-Flight: Validate confirmation + config files
  # ===========================================================================
  preflight:
    name: Pre-Flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Validate Sync Confirmation
        run: |
          if [ "${{ inputs.confirm-sync }}" != "SYNC" ]; then
            echo "ERROR: Sync not confirmed. Type 'SYNC' to proceed."
            exit 1
          fi
          echo "Production config sync confirmed"

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate Dashboard JSON
        run: |
          echo "Validating dashboard JSON files..."
          for f in scripts/monitoring/grafana/dashboards/*.json; do
            python3 -c "import json; json.load(open('$f'))" || { echo "Invalid JSON: $f"; exit 1; }
            echo "  $(basename $f) OK"
          done
          echo "All dashboard files are valid JSON"

      - name: Validate YAML Configs
        run: |
          echo "Validating YAML config files..."
          for f in scripts/monitoring/prometheus/*.yml scripts/monitoring/loki/*.yml scripts/monitoring/promtail/*.yml scripts/monitoring/tempo/*.yml scripts/monitoring/grafana/provisioning/**/*.yml; do
            if [ -f "$f" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$f'))" || { echo "Invalid YAML: $f"; exit 1; }
              echo "  $(basename $f) OK"
            fi
          done
          echo "All YAML config files are valid"

  # ===========================================================================
  # Sync Configs to Production
  # ===========================================================================
  sync:
    name: Sync to Production
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Sync Monitoring Configs
        id: sync
        run: npx tsx scripts/deployment/sync-monitoring-configs.ts production --region ${{ env.AWS_REGION }}

      - name: Summary
        run: |
          echo "## Monitoring Config Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`production\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Bucket | \`${{ steps.sync.outputs.bucket }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | \`${{ steps.sync.outputs.files_synced }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Services Reloaded | \`${{ steps.sync.outputs.services_reloaded }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| EC2 Instance | \`${{ steps.sync.outputs.instance_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SSM Command | \`${{ steps.sync.outputs.command_id }}\` |" >> $GITHUB_STEP_SUMMARY
