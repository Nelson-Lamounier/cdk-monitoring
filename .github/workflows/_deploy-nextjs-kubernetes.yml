# @format
# @description Next.js App Layer Pipeline (Thin Wrapper)
#
# Deploys only the application-layer resources for Next.js on K8s:
#   1. API Stack (API Gateway + Lambda for email subscriptions)
#   2. Sync Static Assets (S3 + CloudFront invalidation)
#   3. Verify & Smoke Tests
#
# Can be triggered two ways:
#   - Chained from _deploy-kubernetes.yml after infra deploy (full deploy)
#   - Standalone via deploy-nextjs-kubernetes-dev.yml (API-only changes)
#
# When called from the K8s pipeline, api-stack-name is provided as input
# (skipping synth). When standalone, it runs its own synth to resolve it.

name: Deploy Next.js App Layer (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (development, staging, production)"
        required: true
        type: string
      cdk-environment:
        description: "CDK environment name"
        required: true
        type: string
      api-stack-name:
        description: "Pre-resolved API stack name (skip synth if provided)"
        required: false
        type: string
        default: ""
      domain-name:
        description: "Domain name for CloudFront (needed for sync + smoke tests)"
        required: false
        type: string
        default: ""
      skip-verification:
        description: "Skip post-deployment verification"
        required: false
        default: false
        type: boolean
    secrets:
      AWS_OIDC_ROLE:
        description: "AWS OIDC role ARN"
        required: false
      VERIFICATION_SECRET:
        required: false

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  DEPLOY_ENVIRONMENT: ${{ inputs.environment }}

jobs:
  # ===========================================================================
  # Setup (only if api-stack-name not provided — standalone mode)
  # ===========================================================================
  setup:
    name: Setup & Resolve Stack
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    if: inputs.api-stack-name == ''
    outputs:
      api-stack: ${{ steps.synth.outputs.api }}
      commit-short-sha: ${{ steps.commit-info.outputs.short_sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Record Commit Information
        id: commit-info
        run: echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build TypeScript
        run: just build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Synthesize & Resolve API Stack Name
        id: synth
        env:
          DOMAIN_NAME: ${{ inputs.domain-name || vars.DOMAIN_NAME }}
          HOSTED_ZONE_ID: ${{ vars.HOSTED_ZONE_ID }}
          CROSS_ACCOUNT_ROLE_ARN: ${{ vars.DNS_VALIDATION_ROLE }}
          NOTIFICATION_EMAIL: ${{ vars.NOTIFICATION_EMAIL }}
          SES_FROM_EMAIL: ${{ vars.SES_FROM_EMAIL }}
          VERIFICATION_SECRET: ${{ secrets.VERIFICATION_SECRET }}
          VERIFICATION_BASE_URL: ${{ vars.VERIFICATION_BASE_URL }}
        run: just ci-synth kubernetes ${{ inputs.cdk-environment }}

  # ===========================================================================
  # Deploy API Stack — API Gateway + Lambda (email subscriptions)
  # ===========================================================================
  deploy-api:
    name: Deploy API
    needs: [setup]
    if: >-
      always()
      && (needs.setup.result == 'success' || needs.setup.result == 'skipped')
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ inputs.api-stack-name || needs.setup.outputs.api-stack }}
      project: kubernetes
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ vars.AWS_ACCOUNT_ID }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: never
      outputs-directory: "deployment-outputs"
      notification-email: ${{ vars.NOTIFICATION_EMAIL }}
      ses-from-email: ${{ vars.SES_FROM_EMAIL }}
      verification-base-url: ${{ vars.VERIFICATION_BASE_URL }}
    secrets: inherit

  # ===========================================================================
  # Sync Static Assets to S3 + CloudFront Cache Invalidation
  # ===========================================================================
  sync-static-assets:
    name: Sync Static Assets
    needs: [setup, deploy-api]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ inputs.environment }}
    if: always() && needs.deploy-api.result == 'success'
    outputs:
      s3-bucket: ${{ steps.sync.outputs.bucket }}
      files-synced: ${{ steps.sync.outputs.files_synced }}
      invalidation-id: ${{ steps.sync.outputs.invalidation_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Sync Assets & Invalidate Cache
        id: sync
        run: |
          SYNC_CMD="just ci-sync-assets ${{ inputs.cdk-environment }}"
          SYNC_CMD="$SYNC_CMD --region ${{ env.AWS_REGION }}"

          DOMAIN="${{ inputs.domain-name }}"
          if [ -z "$DOMAIN" ]; then DOMAIN="${{ vars.DOMAIN_NAME }}"; fi
          if [ -n "$DOMAIN" ]; then
            SYNC_CMD="$SYNC_CMD --domain $DOMAIN"
          fi

          eval $SYNC_CMD

  # ===========================================================================
  # Verify & Smoke Tests
  # ===========================================================================
  verify-and-test:
    name: Verify & Smoke Tests
    needs: [setup, deploy-api, sync-static-assets]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    if: >-
      always()
      && needs.deploy-api.result == 'success'
      && inputs.skip-verification != true

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Run K8s Smoke Tests
        id: smoke
        run: |
          SMOKE_CMD="just ci-smoke-kubernetes ${{ inputs.cdk-environment }} --region ${{ env.AWS_REGION }}"

          DOMAIN="${{ inputs.domain-name }}"
          if [ -z "$DOMAIN" ]; then DOMAIN="${{ vars.DOMAIN_NAME }}"; fi
          if [ -n "$DOMAIN" ]; then
            SMOKE_CMD="$SMOKE_CMD --cloudfront-domain $DOMAIN"
          fi

          if [ -n "${{ needs.sync-static-assets.outputs.s3-bucket }}" ]; then
            SMOKE_CMD="$SMOKE_CMD --s3-bucket ${{ needs.sync-static-assets.outputs.s3-bucket }}"
          fi

          eval $SMOKE_CMD
