# @format
# @description Deploy Next.js K8s to Development
#
# Self-contained K8s deployment for the Next.js application.
# Deploys ALL stacks: Data, K8s-Compute, API, Edge.
# This is the K8s migration equivalent of deploy-nextjs-dev.yml (ECS).
#
# Prerequisites:
#   - Shared VPC from deploy-shared workflow
#   - k3s server (monitoring stack) must be running for agent join

name: Deploy Next.js K8s to Development

on:
  push:
    branches:
      - develop
    paths:
      - "infra/lib/config/nextjs/**"
      - "infra/lib/config/projects.ts"
      - "infra/lib/config/defaults.ts"
      - "infra/lib/projects/nextjs/**"
      - "infra/lib/stacks/nextjs/**"
      - "infra/lib/common/compute/builders/user-data-builder.ts"
      - "infra/lambda/**"
      - "app-deploy/nextjs/**"
      - "k8s-bootstrap/base/**"
      - "k8s-bootstrap/overlays/**"
      - "infra/bin/app.ts"
      - ".github/workflows/deploy-nextjs-kubernetes-dev.yml"
      - ".github/workflows/_deploy-nextjs-kubernetes.yml"
      - ".github/workflows/_deploy-stack.yml"
      - ".github/workflows/_verify-stack.yml"
      - ".github/workflows/_iac-security-scan.yml"
      - ".github/workflows/_smoke-tests-nextjs.yml"
      - ".github/actions/**"
  workflow_dispatch:
    inputs:
      skip_verification:
        description: "Skip post-deployment verification"
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-nextjs-k8s-development
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Development
    uses: ./.github/workflows/_deploy-nextjs-kubernetes.yml
    with:
      environment: development
      cdk-environment: development
      skip-verification: ${{ inputs.skip_verification || false }}
    secrets: inherit
