# @format
# @description Reusable Next.js Deployment Workflow (Consolidated 6-Stack Architecture)
# Stack Order: Data → Compute → Networking → Application → API → Edge (optional)
# Uses shared VPC from Monitoring project
#
# All deployment logic is handled by TypeScript scripts in scripts/deployment/
# Test pipeline V1.05

name: Deploy NextJS (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (development, staging, production)"
        required: true
        type: string
      cdk-environment:
        description: "CDK context environment value (dev, staging, prod)"
        required: true
        type: string
      require-approval:
        description: "CDK approval level"
        required: false
        type: string
        default: "never"
      enable-security-scan:
        description: "Run IaC security scan before deployment"
        required: false
        type: boolean
        default: false
      security-scan-blocking:
        description: "Block deployment on security scan failure"
        required: false
        type: boolean
        default: false
      skip-verification:
        description: "Skip post-deployment verification"
        required: false
        type: boolean
        default: false
      # CloudFront/Edge stack configuration
      # domain-name is optional here — if not provided, resolved from environment vars.DOMAIN_NAME
      # This ensures environment-scoped variables are used (not repository-level vars)
      domain-name:
        description: "Domain name for CloudFront Edge stack (optional — falls back to vars.DOMAIN_NAME from environment)"
        required: false
        type: string
        default: ""
      hosted-zone-id:
        description: "Route53 Hosted Zone ID for DNS validation (optional — falls back to vars.HOSTED_ZONE_ID from environment)"
        required: false
        type: string
        default: ""
      cross-account-role-arn:
        description: "Cross-account IAM role ARN for Route53 access (optional — falls back to vars.DNS_VALIDATION_ROLE from environment)"
        required: false
        type: string
        default: ""
    secrets:
      AWS_OIDC_ROLE:
        description: "AWS OIDC role ARN (resolved from environment context, not passed by caller)"
        required: false
      VERIFICATION_SECRET:
        required: false

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  DEPLOY_ENVIRONMENT: ${{ inputs.environment }}

jobs:
  # ===========================================================================
  # Setup, Build & Synthesize (via synthesize-ci.ts)
  # ===========================================================================
  setup:
    name: Setup & Synthesize
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}
    outputs:
      aws-account-id: ${{ steps.account-id.outputs.account_id }}
      commit-sha: ${{ github.sha }}
      commit-short-sha: ${{ steps.commit-info.outputs.short_sha }}
      synthesis-timestamp: ${{ steps.synth.outputs.timestamp }}
      node-version: ${{ steps.setup-tools.outputs.node-version }}
      # Resolved edge configuration (from environment vars, with input fallback)
      domain-name: ${{ steps.resolve-edge.outputs.domain-name }}
      hosted-zone-id: ${{ steps.resolve-edge.outputs.hosted-zone-id }}
      cross-account-role-arn: ${{ steps.resolve-edge.outputs.cross-account-role-arn }}
      # Consolidated stack names (6 stacks) — from synthesize-ci.ts
      data-stack: ${{ steps.synth.outputs.data }}
      compute-stack: ${{ steps.synth.outputs.compute }}
      networking-stack: ${{ steps.synth.outputs.networking }}
      application-stack: ${{ steps.synth.outputs.application }}
      api-stack: ${{ steps.synth.outputs.api }}
      edge-stack: ${{ steps.synth.outputs.edge }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Record Commit Information
        id: commit-info
        run: |
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Setup Node.js and Yarn
        id: setup-tools
        uses: ./.github/actions/setup-node-yarn

      - name: Validate AWS Account ID
        id: account-id
        run: |
          ACCOUNT_ID="${{ vars.AWS_ACCOUNT_ID }}"

          if [ -z "$ACCOUNT_ID" ]; then
            echo "ERROR: AWS_ACCOUNT_ID variable not configured"
            exit 1
          fi

          if ! [[ "$ACCOUNT_ID" =~ ^[0-9]{12}$ ]]; then
            echo "ERROR: Invalid AWS account ID format"
            exit 1
          fi

          echo "::add-mask::$ACCOUNT_ID"
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "✓ AWS Account ID validated"

      - name: Build TypeScript
        run: yarn build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      # Resolve edge configuration from environment variables (with input fallback)
      # This step runs inside a job with `environment:` set, so vars.* resolves
      # to environment-scoped variables — NOT repository-level variables.
      # This is critical because calling workflows can't access environment vars.
      - name: Resolve Edge Configuration
        id: resolve-edge
        run: |
          # Domain name: input > environment variable
          DOMAIN="${{ inputs.domain-name }}"
          if [ -z "$DOMAIN" ]; then
            DOMAIN="${{ vars.DOMAIN_NAME }}"
          fi
          if [ -z "$DOMAIN" ]; then
            echo "ERROR: No domain name provided."
            echo "Set DOMAIN_NAME in GitHub environment '${{ inputs.environment }}' variables,"
            echo "or pass domain-name input to the workflow."
            exit 1
          fi

          # Hosted zone ID: input > environment variable
          HZ_ID="${{ inputs.hosted-zone-id }}"
          if [ -z "$HZ_ID" ]; then
            HZ_ID="${{ vars.HOSTED_ZONE_ID }}"
          fi
          if [ -z "$HZ_ID" ]; then
            echo "ERROR: No hosted zone ID provided."
            echo "Set HOSTED_ZONE_ID in GitHub environment '${{ inputs.environment }}' variables,"
            echo "or pass hosted-zone-id input to the workflow."
            exit 1
          fi

          # Cross-account role ARN: input > environment variable
          ROLE_ARN="${{ inputs.cross-account-role-arn }}"
          if [ -z "$ROLE_ARN" ]; then
            ROLE_ARN="${{ vars.DNS_VALIDATION_ROLE }}"
          fi
          if [ -z "$ROLE_ARN" ]; then
            echo "ERROR: No cross-account role ARN provided."
            echo "Set DNS_VALIDATION_ROLE in GitHub environment '${{ inputs.environment }}' variables,"
            echo "or pass cross-account-role-arn input to the workflow."
            exit 1
          fi

          echo "domain-name=$DOMAIN" >> $GITHUB_OUTPUT
          echo "hosted-zone-id=$HZ_ID" >> $GITHUB_OUTPUT
          echo "cross-account-role-arn=$ROLE_ARN" >> $GITHUB_OUTPUT

          echo "✓ Edge configuration resolved from environment '${{ inputs.environment }}':"
          echo "  Domain: $DOMAIN"
          echo "  Hosted Zone: $HZ_ID"
          echo "  Role ARN: $ROLE_ARN"

      - name: Synthesize & Determine Stack Names
        id: synth
        env:
          # Edge configuration (resolved from environment in previous step)
          # app.ts reads these and bridges them into factory context overrides
          DOMAIN_NAME: ${{ steps.resolve-edge.outputs.domain-name }}
          HOSTED_ZONE_ID: ${{ steps.resolve-edge.outputs.hosted-zone-id }}
          CROSS_ACCOUNT_ROLE_ARN: ${{ steps.resolve-edge.outputs.cross-account-role-arn }}
          # Email subscription configuration (from GitHub environment variables)
          NOTIFICATION_EMAIL: ${{ vars.NOTIFICATION_EMAIL }}
          SES_FROM_EMAIL: ${{ vars.SES_FROM_EMAIL }}
          VERIFICATION_SECRET: ${{ secrets.VERIFICATION_SECRET }}
          VERIFICATION_BASE_URL: ${{ vars.VERIFICATION_BASE_URL }}
        run: npx tsx scripts/deployment/synthesize-ci.ts nextjs ${{ inputs.cdk-environment }}

      - name: Upload Synthesized Templates
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cdk-out-nextjs-${{ inputs.cdk-environment }}-${{ steps.commit-info.outputs.short_sha }}
          path: cdk.out/
          retention-days: 30

      - name: Upload for Security Scan
        if: inputs.enable-security-scan
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cdk-synthesis
          path: cdk.out/
          retention-days: 7

  # ===========================================================================
  # IaC Security Scan (Conditional)
  # ===========================================================================
  security-scan:
    name: Security Scan
    needs: setup
    if: inputs.enable-security-scan
    uses: ./.github/workflows/_iac-security-scan.yml
    with:
      environment: ${{ inputs.environment }}
      enforce-blocking: ${{ inputs.security-scan-blocking }}
      cdk-output-path: "cdk.out"
      skip-checks: ""
      soft-fail-on: ${{ inputs.security-scan-blocking && '' || 'LOW' }}
    secrets: inherit

  # ===========================================================================
  # Drift Detection (all environments)
  #
  # Runs cdk diff for all stacks before deployment to surface expected
  # changes in the step summary. Informational only — does not block.
  # ===========================================================================
  drift-detection:
    name: Drift Detection
    needs: [setup]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Run Drift Detection
        run: npx tsx scripts/deployment/drift-detection.ts nextjs ${{ inputs.cdk-environment }} --region ${{ env.AWS_REGION }}
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  # ===========================================================================
  # Template Validation (cfn-lint)
  #
  # Validates synthesized CloudFormation templates against AWS specifications.
  # Catches resource property errors, cross-region issues, and type mismatches.
  # BLOCKING — failed validation prevents deployment.
  # ===========================================================================
  validate-templates:
    name: Validate Templates
    needs: [setup]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Checkout for .cfnlintrc config (sparse — only config file)
      - name: Checkout Config
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: .cfnlintrc
          sparse-checkout-cone-mode: false

      - name: Download Synthesized Templates
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: cdk-out-nextjs-${{ inputs.cdk-environment }}-${{ needs.setup.outputs.commit-short-sha }}
          path: cdk.out/

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: Count Templates
        run: |
          TEMPLATE_COUNT=$(find cdk.out -name "*.template.json" | wc -l)
          echo "Found $TEMPLATE_COUNT CloudFormation templates"
          find cdk.out -name "*.template.json" | head -20

      - name: Validate CloudFormation Templates
        shell: python3 {0}
        run: |
          import sys, glob

          # CDK generates deeply nested intrinsic functions that exceed
          # Python's default recursion limit of 1000.
          sys.setrecursionlimit(10000)

          from cfnlint import decode, runner
          from cfnlint.config import ConfigMixIn

          templates = sorted(glob.glob("cdk.out/**/*.template.json", recursive=True))
          print(f"Validating {len(templates)} templates...")
          print(f"Python recursion limit: {sys.getrecursionlimit()}")

          total_errors = 0
          for tpl in templates:
              print(f"\n--- {tpl} ---")
              try:
                  config = ConfigMixIn(["--template", tpl])
                  matches = list(runner.Runner(config).run())
                  if matches:
                      total_errors += len(matches)
                      for match in matches:
                          print(f"  {match}")
                  else:
                      print("  ✅ passed")
              except RecursionError:
                  print(f"  ⚠️  skipped (template too deeply nested for cfn-lint)")
              except Exception as e:
                  print(f"  ⚠️  skipped ({type(e).__name__}: {e})")

          if total_errors > 0:
              print(f"\n❌ {total_errors} validation errors found")
              sys.exit(1)
          else:
              print(f"\n✅ All {len(templates)} templates passed validation")

      - name: Generate Validation Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## CloudFormation Template Validation

          | Setting | Value |
          |---------|-------|
          | Tool | cfn-lint |
          | Config | `.cfnlintrc` |

          Templates validated from `cdk.out/` directory.
          EOF

  # ===========================================================================
  # Deploy Data Stack (1/6) — ECR + DynamoDB + S3 + SSM
  # ===========================================================================
  deploy-data:
    name: Deploy Data
    needs: [setup, validate-templates, security-scan, drift-detection]
    if: always() && needs.setup.result == 'success' && needs.validate-templates.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.data-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
    secrets: inherit

  # ===========================================================================
  # Deploy Compute Stack (2/6) — ECS Cluster + IAM + ASG
  # ===========================================================================
  deploy-compute:
    name: Deploy Compute
    needs: [setup, deploy-data]
    if: always() && needs.deploy-data.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.compute-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
    secrets: inherit

  # ===========================================================================
  # Deploy Networking Stack (3/6) — ALB + Target Group + SG
  # ===========================================================================
  deploy-networking:
    name: Deploy Networking
    needs: [setup, deploy-compute]
    if: always() && needs.deploy-compute.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.networking-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
      # Edge config — Networking needs these for ALB HTTPS certificate
      domain-name: ${{ needs.setup.outputs.domain-name }}
      hosted-zone-id: ${{ needs.setup.outputs.hosted-zone-id }}
      cross-account-role-arn: ${{ needs.setup.outputs.cross-account-role-arn }}
    secrets: inherit

  # ===========================================================================
  # Deploy Application Stack (4/6) — Task Definition + ECS Service
  # ===========================================================================
  deploy-application:
    name: Deploy Application
    needs: [setup, deploy-data, deploy-compute, deploy-networking]
    if: always() && needs.deploy-data.result == 'success' && needs.deploy-compute.result == 'success' && needs.deploy-networking.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.application-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
    secrets: inherit

  # ===========================================================================
  # Deploy API Stack (5/6) — API Gateway + Lambda
  # ===========================================================================
  deploy-api:
    name: Deploy API
    needs: [setup, deploy-data]
    if: always() && needs.deploy-data.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.api-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
      # Email/API config — only the API stack needs these
      notification-email: ${{ vars.NOTIFICATION_EMAIL }}
      ses-from-email: ${{ vars.SES_FROM_EMAIL }}
      verification-base-url: ${{ vars.VERIFICATION_BASE_URL }}
    secrets: inherit

  # ===========================================================================
  # Deploy Edge Stack (6/6) — CloudFront + ACM + WAF (us-east-1)
  # ===========================================================================
  deploy-edge:
    name: Deploy Edge
    needs: [setup, deploy-networking, deploy-application, deploy-api]
    if: always() && needs.deploy-networking.result == 'success' && needs.deploy-application.result == 'success' && needs.deploy-api.result == 'success'
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.edge-stack }}
      project: nextjs
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.ROUTE53_REGION || 'us-east-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
      # Edge config — edge stack needs these for CloudFront + ACM
      domain-name: ${{ needs.setup.outputs.domain-name }}
      hosted-zone-id: ${{ needs.setup.outputs.hosted-zone-id }}
      cross-account-role-arn: ${{ needs.setup.outputs.cross-account-role-arn }}
    secrets: inherit

  # ===========================================================================
  # Verify Service (via verify-nextjs.ts)
  # ===========================================================================
  verify-service:
    name: Verify Service
    needs: [setup, deploy-application, deploy-networking]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    if: always() && needs.deploy-application.result == 'success' && inputs.skip-verification != true
    outputs:
      alb-dns: ${{ steps.verify.outputs.alb_dns }}
      health-check-passed: ${{ steps.verify.outputs.health_check_passed }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Verify NextJS Deployment
        id: verify
        continue-on-error: ${{ inputs.environment != 'production' }}
        run: npx tsx scripts/deployment/verify-nextjs.ts ${{ inputs.cdk-environment }} --region ${{ env.AWS_REGION }}

  # ===========================================================================
  # Sync Static Assets to S3 + CloudFront Cache Invalidation (via sync-assets-ci.ts)
  # ===========================================================================
  sync-static-assets:
    name: Sync Static Assets
    needs: [setup, deploy-data, deploy-edge]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ inputs.environment }}
    if: always() && needs.deploy-data.result == 'success' && (needs.deploy-edge.result == 'success' || needs.deploy-edge.result == 'skipped')
    outputs:
      s3-bucket: ${{ steps.sync.outputs.bucket }}
      files-synced: ${{ steps.sync.outputs.files_synced }}
      invalidation-id: ${{ steps.sync.outputs.invalidation_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Download Build Artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: cdk-out-nextjs-${{ inputs.cdk-environment }}-${{ needs.setup.outputs.commit-short-sha }}
          path: cdk.out/

      - name: Sync Assets & Invalidate Cache
        id: sync
        run: |
          SYNC_CMD="npx tsx scripts/deployment/sync-assets-ci.ts ${{ inputs.cdk-environment }}"
          SYNC_CMD="$SYNC_CMD --region ${{ env.AWS_REGION }}"

          if [ -n "${{ needs.setup.outputs.domain-name }}" ]; then
            SYNC_CMD="$SYNC_CMD --domain ${{ needs.setup.outputs.domain-name }}"
          fi

          eval $SYNC_CMD

  # ===========================================================================
  # Smoke Tests (via _smoke-tests-nextjs.yml)
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    needs: [setup, deploy-application, verify-service, sync-static-assets]
    if: >-
      always()
      && needs.deploy-application.result == 'success'
      && (needs.verify-service.result == 'success' || needs.verify-service.result == 'skipped')
      && inputs.skip-verification != true
    uses: ./.github/workflows/_smoke-tests-nextjs.yml
    with:
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      alb-dns: ${{ needs.verify-service.outputs.alb-dns }}
      cloudfront-domain: ${{ needs.setup.outputs.domain-name }}
      s3-assets-bucket: ${{ needs.sync-static-assets.outputs.s3-bucket }}
      timeout-minutes: 10
    secrets: inherit

  # ===========================================================================
  # Deployment Summary (via deployment-summary.ts)
  # ===========================================================================
  summary:
    name: Deployment Summary
    needs:
      - setup
      - security-scan
      - drift-detection
      - deploy-data
      - deploy-compute
      - deploy-networking
      - deploy-application
      - deploy-api
      - deploy-edge
      - sync-static-assets
      - verify-service
      - smoke-tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      - name: Check Prerequisites
        id: prereqs
        run: |
          if [ "${{ needs.setup.result }}" != "success" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ⚠️ Pipeline Aborted

          **Reason**: Setup job did not complete successfully (${{ needs.setup.result }})
          **Commit**: `${{ github.sha }}`
          **Environment**: ${{ inputs.environment }}

          No stacks were deployed. Check the setup job logs for details.
          EOF
            echo "::warning::Setup did not succeed (${{ needs.setup.result }}), skipping full summary"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.prereqs.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        if: steps.prereqs.outputs.skip != 'true'
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        if: steps.prereqs.outputs.skip != 'true'
        run: yarn install --frozen-lockfile

      - name: Generate Summary
        if: steps.prereqs.outputs.skip != 'true'
        env:
          DEPLOY_DATA_RESULT: ${{ needs.deploy-data.result }}
          DEPLOY_COMPUTE_RESULT: ${{ needs.deploy-compute.result }}
          DEPLOY_NETWORKING_RESULT: ${{ needs.deploy-networking.result }}
          DEPLOY_APPLICATION_RESULT: ${{ needs.deploy-application.result }}
          DEPLOY_API_RESULT: ${{ needs.deploy-api.result }}
          DEPLOY_EDGE_RESULT: ${{ needs.deploy-edge.result || 'skipped' }}
          SECURITY_SCAN_RESULT: ${{ needs.security-scan.result || 'skipped' }}
          VERIFY_RESULT: ${{ needs.verify-service.result || 'skipped' }}
          SMOKE_TESTS_RESULT: ${{ needs.smoke-tests.result || 'skipped' }}
          SYNC_ASSETS_RESULT: ${{ needs.sync-static-assets.result || 'skipped' }}
          COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit-short-sha }}
        run: yarn tsx scripts/deployment/deployment-summary.ts nextjs ${{ inputs.cdk-environment }}
