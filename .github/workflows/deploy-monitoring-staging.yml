# @format
# @description Deploy Monitoring to Staging - Creates immutable artifact for production

name: Deploy Monitoring to Staging

on:
  push:
    branches:
      - staging
    paths:
      - "infra/lib/**"
      - "bin/**"
      - ".github/workflows/deploy-monitoring-staging.yml"
      - ".github/workflows/_deploy-monitoring.yml"
      - ".github/workflows/_deploy-stack.yml"
      - ".github/workflows/_verify-stack.yml"
      - ".github/actions/**"
  workflow_dispatch:
    inputs:
      skip_verification:
        description: "Skip post-deployment verification"
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-monitoring-staging
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Staging
    uses: ./.github/workflows/_deploy-monitoring.yml
    with:
      environment: staging
      cdk-environment: staging
      require-approval: never
      enable-security-scan: true
      security-scan-blocking: true
      skip-verification: ${{ inputs.skip_verification || false }}
      create-production-artifact: true
    secrets:
      AWS_OIDC_ROLE: ${{ secrets.AWS_OIDC_ROLE }}

