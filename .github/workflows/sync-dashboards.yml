# @format
# @description Sync Grafana Dashboards
# Lightweight workflow that syncs dashboard JSON files to S3 and triggers
# an EC2 hot-reload via SSM â€” no full CDK deploy needed.
#
# Triggers:
#   - Push to main with dashboard file changes
#   - Manual dispatch

name: Sync Grafana Dashboards

on:
  push:
    branches: [main]
    paths:
      - "scripts/monitoring/grafana/dashboards/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: "development"

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}

jobs:
  sync-dashboards:
    name: Sync Dashboards
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ inputs.environment || 'development' }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Validate Dashboard JSON
        run: |
          echo "Validating dashboard JSON files..."
          for f in scripts/monitoring/grafana/dashboards/*.json; do
            python3 -c "import json; json.load(open('$f'))" || { echo "âŒ Invalid JSON: $f"; exit 1; }
            echo "  âœ“ $(basename $f)"
          done
          echo "âœ… All dashboard files are valid JSON"

      - name: Sync Dashboards
        id: sync
        run: npx tsx scripts/deployment/sync-dashboards.ts ${{ inputs.environment || 'development' }} --region ${{ env.AWS_REGION }}

      - name: Summary
        run: |
          echo "## ðŸ“Š Dashboard Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment || 'development' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Bucket | \`${{ steps.sync.outputs.bucket }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | \`${{ steps.sync.outputs.files_synced }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| EC2 Instance | \`${{ steps.sync.outputs.instance_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SSM Command | \`${{ steps.sync.outputs.command_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Grafana auto-detects file changes within 30 seconds" >> $GITHUB_STEP_SUMMARY
