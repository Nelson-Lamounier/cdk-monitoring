# @format
# @description Deploy K8s Infrastructure to Development
#
# Unified infrastructure pipeline for the K8s cluster.
# Deploys CDK stacks, syncs bootstrap scripts, builds Golden AMI,
# and runs verification — all in one pipeline.
#
# 8-Stack Architecture: Data → Base → Compute → AppIam → Api → Edge.
# Application manifests (monitoring, nextjs) are deployed separately
# by the sync-k8s-app-deploy-dev.yml pipeline.
#
# Prerequisites:
#   - Shared VPC from deploy-shared workflow

name: Deploy K8s to Development

on:
  push:
    branches:
      - develop
      - feature/k3s-kubernetes-migration
    paths:
      # CDK infrastructure
      - "infra/lib/config/k8s/**"
      - "infra/lib/config/nextjs/**"
      - "infra/lib/config/projects.ts"
      - "infra/lib/config/defaults.ts"
      - "infra/lib/projects/k8s/**"
      - "infra/lib/stacks/kubernetes/**"
      - "infra/lib/common/compute/builders/user-data-builder.ts"
      - "infra/lambda/**"
      - "infra/bin/app.ts"
      # Bootstrap scripts (synced to S3 inside _deploy-kubernetes.yml)
      - "kubernetes-app/k8s-bootstrap/**"
      # Application manifests (synced to S3, picked up by ArgoCD)
      - "kubernetes-app/app-deploy/**"
      # Golden AMI pipeline construct
      - "infra/lib/common/compute/constructs/golden-ami-pipeline.ts"
      # Golden AMI recipes
      - "kubernetes-app/infra-ami/**"
      # Pipeline definitions
      - ".github/workflows/deploy-kubernetes-dev.yml"
      - ".github/workflows/_deploy-kubernetes.yml"
      - ".github/workflows/_deploy-stack.yml"
      - ".github/workflows/_build-golden-ami.yml"
      - ".github/workflows/_sync-k8s-content.yml"
      - ".github/workflows/_iac-security-scan.yml"
      - ".github/actions/**"
  # Weekly: AMI refresh for OS security patches
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      skip_verification:
        description: "Skip post-deployment verification"
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-k8s-development
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Development
    uses: ./.github/workflows/_deploy-kubernetes.yml
    with:
      environment: development
      cdk-environment: development
      require-approval: never
      enable-security-scan: true
      security-scan-blocking: false
      skip-verification: ${{ inputs.skip_verification || false }}
    secrets: inherit
