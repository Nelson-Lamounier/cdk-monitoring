# @format
# @description Next.js Smoke Tests Workflow
# Runs comprehensive smoke tests on deployed Next.js ECS infrastructure
# All test logic delegated to scripts/deployment/smoke-tests-nextjs.ts

name: NextJS Smoke Tests (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: string
      aws-account-id:
        description: "AWS Account ID"
        required: true
        type: string
      aws-region:
        description: "AWS Region"
        required: false
        type: string
        default: "eu-west-1"
      alb-dns:
        description: "ALB DNS name for endpoint testing"
        required: false
        type: string
      cloudfront-domain:
        description: "CloudFront domain for HTTPS testing"
        required: false
        type: string
      s3-assets-bucket:
        description: "S3 assets bucket name"
        required: false
        type: string
      timeout-minutes:
        description: "Job timeout in minutes"
        required: false
        type: number
        default: 10
    secrets:
      AWS_OIDC_ROLE:
        required: false

env:
  NODE_VERSION: "22"

jobs:
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    environment: ${{ inputs.environment }}
    outputs:
      status: ${{ steps.tests.outputs.status }}
      ecs-status: ${{ steps.tests.outputs.ecs_status }}
      alb-status: ${{ steps.tests.outputs.alb_status }}
      static-assets-status: ${{ steps.tests.outputs.static_assets_status }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ inputs.aws-region }}
          audience: sts.amazonaws.com

      - name: Run Smoke Tests
        id: tests
        continue-on-error: ${{ inputs.environment != 'production' }}
        run: |
          TEST_CMD="npx tsx scripts/deployment/smoke-tests-nextjs.ts ${{ inputs.environment }}"
          TEST_CMD="$TEST_CMD --region ${{ inputs.aws-region }}"

          if [ -n "${{ inputs.alb-dns }}" ]; then
            TEST_CMD="$TEST_CMD --alb-dns ${{ inputs.alb-dns }}"
          fi

          if [ -n "${{ inputs.cloudfront-domain }}" ]; then
            TEST_CMD="$TEST_CMD --cloudfront-domain ${{ inputs.cloudfront-domain }}"
          fi

          if [ -n "${{ inputs.s3-assets-bucket }}" ]; then
            TEST_CMD="$TEST_CMD --s3-bucket ${{ inputs.s3-assets-bucket }}"
          fi

          eval $TEST_CMD
