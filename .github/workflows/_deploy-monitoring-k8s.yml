# @format
# @description Reusable Monitoring k3s Kubernetes Deployment Workflow
# Single-Stack Architecture: Compute (EC2 + k3s + EBS + EIP)
# Uses Shared VPC from deploy-shared workflow
#
# Inline logic extracted to TypeScript scripts in scripts/deployment/

name: Deploy Monitoring k8s (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (development, staging, production)"
        required: true
        type: string
      cdk-environment:
        description: "CDK context environment value (dev, staging, prod)"
        required: true
        type: string
      require-approval:
        description: "CDK approval level"
        required: false
        type: string
        default: "never"
      enable-security-scan:
        description: "Run IaC security scan before deployment"
        required: false
        type: boolean
        default: false
      security-scan-blocking:
        description: "Block deployment on security scan failure"
        required: false
        type: boolean
        default: false
      skip-verification:
        description: "Skip post-deployment verification"
        required: false
        type: boolean
        default: false
      create-production-artifact:
        description: "Create immutable artifact for production"
        required: false
        type: boolean
        default: false
    secrets:
      AWS_OIDC_ROLE:
        description: "AWS OIDC role ARN (resolved from environment context)"
        required: false

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION || 'eu-west-1' }}
  DEPLOY_ENVIRONMENT: ${{ inputs.environment }}

jobs:
  # ===========================================================================
  # Setup, Build & Synthesize
  # ===========================================================================
  setup:
    name: Setup & Synthesize
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}
    outputs:
      aws-account-id: ${{ steps.account-id.outputs.account_id }}
      commit-sha: ${{ github.sha }}
      commit-short-sha: ${{ steps.commit-info.outputs.short_sha }}
      node-version: ${{ steps.setup-tools.outputs.node-version }}
      # Stack names from synthesize-ci.ts (single-stack architecture)
      compute-stack: ${{ steps.synth.outputs.compute }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Record Commit Information
        id: commit-info
        run: echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Setup Node.js and Yarn
        id: setup-tools
        uses: ./.github/actions/setup-node-yarn

      - name: Validate AWS Account ID
        id: account-id
        run: |
          ACCOUNT_ID="${{ vars.AWS_ACCOUNT_ID }}"
          if [ -z "$ACCOUNT_ID" ]; then
            echo "ERROR: AWS_ACCOUNT_ID variable not configured"
            exit 1
          fi
          if ! [[ "$ACCOUNT_ID" =~ ^[0-9]{12}$ ]]; then
            echo "ERROR: Invalid AWS account ID format"
            exit 1
          fi
          echo "::add-mask::$ACCOUNT_ID"
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Build TypeScript
        run: yarn build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Synthesize & Determine Stack Names
        id: synth
        run: npx tsx scripts/deployment/synthesize-ci.ts k8s ${{ inputs.cdk-environment }}

      - name: Upload Synthesized Templates
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cdk-out-k8s-${{ inputs.cdk-environment }}-${{ steps.commit-info.outputs.short_sha }}
          path: cdk.out/
          retention-days: ${{ inputs.create-production-artifact && 90 || 30 }}

      - name: Upload for Security Scan
        if: inputs.enable-security-scan
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cdk-synthesis
          path: cdk.out/
          retention-days: 7

  # ===========================================================================
  # IaC Security Scan (Conditional)
  # ===========================================================================
  security-scan:
    name: Security Scan
    needs: setup
    if: inputs.enable-security-scan
    uses: ./.github/workflows/_iac-security-scan.yml
    with:
      environment: ${{ inputs.environment }}
      enforce-blocking: ${{ inputs.security-scan-blocking }}
      cdk-output-path: "cdk.out"
      skip-checks: ""
      soft-fail-on: ${{ inputs.security-scan-blocking && '' || 'LOW' }}

  # ===========================================================================
  # Drift Detection (staging/production only â€” informational)
  #
  # Runs `cdk diff` for all stacks and surfaces the output in the step
  # summary. Gives reviewers visibility into what's actually changing
  # and catches unexpected infrastructure drift before deployment.
  # ===========================================================================
  drift-detection:
    name: Drift Detection
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    if: needs.setup.result == 'success' && inputs.cdk-environment != 'development'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Run Drift Detection
        id: diff
        run: npx tsx scripts/deployment/drift-detection.ts k8s ${{ inputs.cdk-environment }} --region ${{ env.AWS_REGION }}
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}

  # ===========================================================================
  # Deploy Compute Stack (EC2 + k3s + EBS + EIP)
  # ===========================================================================
  deploy-compute:
    name: Deploy Compute
    needs: [setup, security-scan, drift-detection]
    if: always() && needs.setup.result == 'success' && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped') && (needs.drift-detection.result == 'success' || needs.drift-detection.result == 'skipped')
    uses: ./.github/workflows/_deploy-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.compute-stack }}
      project: k8s
      environment: ${{ inputs.environment }}
      aws-account-id: ${{ needs.setup.outputs.aws-account-id }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
      require-approval: ${{ inputs.require-approval }}
      outputs-directory: "deployment-outputs"
    secrets: inherit

  # ===========================================================================
  # Deploy Monitoring Manifests to k3s
  #
  # After CDK provisions infrastructure, deploys k8s monitoring manifests
  # via SSM Run Command. This gives full pipeline visibility into manifest
  # deployment (vs. just CloudWatch logs from UserData).
  #
  # The SSM document runs deploy-manifests.sh which:
  #   1. Re-syncs manifests from S3
  #   2. Resolves secrets from SSM
  #   3. Applies via kubectl apply -k
  #   4. Waits for pod readiness
  #   5. Registers Loki/Tempo endpoints in SSM
  # ===========================================================================
  deploy-manifests:
    name: Deploy Manifests
    needs: [setup, deploy-compute]
    if: always() && needs.deploy-compute.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Get Instance ID from SSM
        id: instance
        run: |
          SSM_PREFIX="/${{ inputs.environment == 'production' && 'k8s/production' || 'k8s/development' }}"
          INSTANCE_ID=$(aws ssm get-parameter \
            --name "${SSM_PREFIX}/instance-id" \
            --query 'Parameter.Value' \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -z "$INSTANCE_ID" ]; then
            echo "::warning::Instance ID not found in SSM â€” skipping manifest deployment"
            echo "::notice::First boot will apply manifests automatically via UserData"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Instance: ${INSTANCE_ID}"
          fi

      - name: Wait for SSM Agent
        if: steps.instance.outputs.skip != 'true'
        run: |
          INSTANCE_ID="${{ steps.instance.outputs.instance_id }}"
          echo "Waiting for SSM Agent on ${INSTANCE_ID}..."
          MAX_WAIT=120
          WAITED=0
          while true; do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text --region ${{ env.AWS_REGION }} 2>/dev/null || echo "NotFound")
            
            if [ "$STATUS" = "Online" ]; then
              echo "âœ“ SSM Agent online (waited ${WAITED}s)"
              break
            fi
            
            if [ $WAITED -ge $MAX_WAIT ]; then
              echo "::error::SSM Agent not online after ${MAX_WAIT}s"
              exit 1
            fi
            
            sleep 5
            WAITED=$((WAITED + 5))
          done

      - name: Deploy Manifests via SSM
        if: steps.instance.outputs.skip != 'true'
        id: deploy
        run: |
          INSTANCE_ID="${{ steps.instance.outputs.instance_id }}"
          DOC_NAME="${{ inputs.environment == 'production' && 'k8s-production' || 'k8s-development' }}-deploy-manifests"

          echo "Sending SSM command: ${DOC_NAME} â†’ ${INSTANCE_ID}"
          COMMAND_ID=$(aws ssm send-command \
            --document-name "${DOC_NAME}" \
            --targets "Key=instanceids,Values=${INSTANCE_ID}" \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text \
            --region ${{ env.AWS_REGION }})

          echo "command_id=${COMMAND_ID}" >> $GITHUB_OUTPUT
          echo "SSM Command: ${COMMAND_ID}"

          # Poll for completion
          WAITED=0
          while true; do
            CMD_STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --query "Status" \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null || echo "InProgress")
            
            if [ "$CMD_STATUS" = "Success" ]; then
              echo "âœ“ Manifest deployment completed successfully"
              break
            elif [ "$CMD_STATUS" = "Failed" ] || [ "$CMD_STATUS" = "Cancelled" ] || [ "$CMD_STATUS" = "TimedOut" ]; then
              echo "::error::SSM command ${CMD_STATUS}"
              # Fetch output for debugging
              aws ssm get-command-invocation \
                --command-id "${COMMAND_ID}" \
                --instance-id "${INSTANCE_ID}" \
                --region ${{ env.AWS_REGION }} 2>/dev/null || true
              exit 1
            fi
            
            if [ $WAITED -ge 600 ]; then
              echo "::error::SSM command timed out after 600s"
              exit 1
            fi
            
            sleep 10
            WAITED=$((WAITED + 10))
            echo "  Status: ${CMD_STATUS} (${WAITED}s elapsed)"
          done

      - name: Trigger ArgoCD Sync
        if: steps.instance.outputs.skip != 'true'
        continue-on-error: true
        run: |
          INSTANCE_ID="${{ steps.instance.outputs.instance_id }}"
          echo "Triggering ArgoCD sync for monitoring app..."

          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${INSTANCE_ID}" \
            --parameters 'commands=["if command -v argocd &>/dev/null; then argocd app sync monitoring --grpc-web 2>/dev/null || echo \"ArgoCD sync skipped (not configured)\"; else echo \"ArgoCD not installed â€” skipping sync\"; fi"]' \
            --timeout-seconds 60 \
            --query "Command.CommandId" \
            --output text \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "")

          if [ -n "${COMMAND_ID}" ]; then
            echo "ArgoCD sync triggered: ${COMMAND_ID}"
          else
            echo "ArgoCD sync skipped (SSM command failed)"
          fi

      - name: Collect Deployment Logs
        if: steps.instance.outputs.skip != 'true' && always()
        run: |
          COMMAND_ID="${{ steps.deploy.outputs.command_id }}"
          INSTANCE_ID="${{ steps.instance.outputs.instance_id }}"

          if [ -n "${COMMAND_ID}" ]; then
            echo "### ðŸ“‹ Manifest Deployment Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardOutputContent" \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Output unavailable"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Verify Deployment
  # ===========================================================================
  verify:
    name: Verify Deployment
    needs: [setup, deploy-compute, deploy-manifests]
    if: always() && needs.deploy-compute.result == 'success' && (needs.deploy-manifests.result == 'success' || needs.deploy-manifests.result == 'skipped') && inputs.skip-verification != true
    uses: ./.github/workflows/_verify-stack.yml
    with:
      stack-name: ${{ needs.setup.outputs.compute-stack }}
      environment: ${{ inputs.environment }}
      aws-region: ${{ vars.AWS_REGION || 'eu-west-1' }}
    secrets:
      AWS_OIDC_ROLE: ${{ secrets.AWS_OIDC_ROLE }}

  # ===========================================================================
  # Rollback (Conditional â€” staging/production only)
  #
  # Triggers when Compute deployed successfully but verification failed.
  # Rolls back CloudFormation to the previous known-good template.
  # ===========================================================================
  rollback:
    name: Rollback Compute
    needs: [setup, deploy-compute, deploy-manifests, verify]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}
    if: |
      always()
      && needs.deploy-compute.result == 'success'
      && needs.verify.result == 'failure'
      && inputs.cdk-environment != 'development'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Rollback Compute Stack
        id: rollback
        run: npx tsx scripts/deployment/rollback.ts "${{ needs.setup.outputs.compute-stack }}" --region ${{ env.AWS_REGION }}

  # ===========================================================================
  # Deployment Summary (TypeScript)
  # ===========================================================================
  summary:
    name: Deployment Summary
    needs:
      [setup, security-scan, deploy-compute, deploy-manifests, verify, rollback]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()

    steps:
      # Guard: if setup was cancelled/failed, write minimal fallback and skip TS
      - name: Check Prerequisites
        id: prereqs
        run: |
          if [ "${{ needs.setup.result }}" != "success" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âš ï¸ Pipeline Aborted

          **Reason**: Setup job did not complete successfully (`${{ needs.setup.result }}`)
          **Commit**: `${{ github.sha }}`
          **Environment**: ${{ inputs.environment }}

          No stacks were deployed. Check the setup job logs for details.
          EOF
            echo "::warning::Setup did not succeed (${{ needs.setup.result }}), skipping full summary"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.prereqs.outputs.skip != 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js and Yarn
        if: steps.prereqs.outputs.skip != 'true'
        uses: ./.github/actions/setup-node-yarn
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: Install Dependencies
        if: steps.prereqs.outputs.skip != 'true'
        run: yarn install --frozen-lockfile

      - name: Generate Summary
        if: steps.prereqs.outputs.skip != 'true'
        env:
          DEPLOY_COMPUTE_RESULT: ${{ needs.deploy-compute.result }}
          SECURITY_SCAN_RESULT: ${{ needs.security-scan.result || 'skipped' }}
          VERIFY_RESULT: ${{ needs.verify.result || 'skipped' }}
          ROLLBACK_RESULT: ${{ needs.rollback.result || 'skipped' }}
          COMMIT_SHORT_SHA: ${{ needs.setup.outputs.commit-short-sha }}
        run: yarn tsx scripts/deployment/deployment-summary.ts k8s ${{ inputs.cdk-environment }}
