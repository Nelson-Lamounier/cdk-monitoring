# @format
# Traefik OTLP Tracing Configuration
#
# Enables distributed tracing on the k3s Traefik ingress controller.
# Traces are exported to Tempo via OTLP gRPC (in-cluster DNS).
#
# This is a k3s HelmChartConfig — k3s watches this resource and
# applies the values to the bundled Traefik Helm chart automatically.
#
# See: https://docs.k3s.io/helm#customizing-packaged-components-with-helmchartconfig
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # Enable Prometheus metrics
    metrics:
      prometheus:
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true
        addServicesLabels: true

    # Enable OTLP tracing → Tempo
    tracing:
      otlp:
        grpc:
          endpoint: "tempo.monitoring.svc.cluster.local:4317"
          insecure: true

    # Expose metrics port for Prometheus scraping
    ports:
      metrics:
        port: 9100
        expose: false
        exposedPort: 9100
        protocol: TCP

    # Additional CLI arguments
    additionalArguments:
      - "--tracing.otlp.grpc.endpoint=tempo.monitoring.svc.cluster.local:4317"
      - "--tracing.otlp.grpc.insecure=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entryPoint=metrics"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
