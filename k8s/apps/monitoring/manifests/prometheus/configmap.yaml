# @format
# Prometheus configuration — K8s-native service discovery
#
# Scrape targets:
#   1. prometheus  — self-monitoring
#   2. node-exporter — DaemonSet on ALL nodes (hostNetwork:true)
#      Uses kubernetes_sd_configs to discover each pod individually
#      so per-node labels (server vs application) are preserved.
#   3. nextjs-app  — Next.js /api/metrics via K8s Service DNS
#   4. github-actions — GitHub Actions exporter
#
# Replaced ECS-era discovery:
#   - ec2_sd_configs (tag:Purpose=NextJS) → kubernetes_sd_configs
#   - dns_sd_configs (nextjs-app.nextjs.local) → K8s service DNS
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
  labels:
    app: prometheus
    app.kubernetes.io/part-of: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        monitor: "k8s-monitoring"

    alerting:
      alertmanagers:
        - static_configs:
            - targets: []

    rule_files:
      - /etc/prometheus/alert_rules.yml

    scrape_configs:
      # -----------------------------------------------------------------
      # 1. Prometheus self-monitoring
      # -----------------------------------------------------------------
      - job_name: "prometheus"
        static_configs:
          - targets: ["localhost:9090"]

      # -----------------------------------------------------------------
      # 2. Node Exporter (DaemonSet — all nodes)
      #
      # kubernetes_sd_configs discovers each DaemonSet pod individually,
      # giving per-node labels (hostname, node role) for Grafana dashboards.
      #
      # The DaemonSet uses hostNetwork:true so containerPort == hostPort.
      # Tolerations: Exists means it runs on BOTH server and agent nodes.
      # -----------------------------------------------------------------
      - job_name: "node-exporter"
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["monitoring"]
        relabel_configs:
          # Only scrape pods with app=node-exporter
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: node-exporter
            action: keep
          # Use the node name as the instance label
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: instance
          # Add node_name label for dashboard filtering
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node_name
          # Use the host IP (hostNetwork pods bind to node IP)
          - source_labels: [__meta_kubernetes_pod_host_ip]
            regex: (.+)
            target_label: __address__
            replacement: "${1}:9100"

      # -----------------------------------------------------------------
      # 3. Next.js Application Metrics
      #
      # Scrapes /api/metrics from the Next.js K8s Service via cluster DNS.
      # Replaces the ECS Cloud Map DNS target (nextjs-app.nextjs.local).
      # -----------------------------------------------------------------
      - job_name: "nextjs-application-metrics"
        metrics_path: "/api/metrics"
        scrape_interval: 30s
        dns_sd_configs:
          - names:
              - "nextjs.nextjs-app.svc.cluster.local"
            type: A
            port: 3000
            refresh_interval: 30s
        relabel_configs:
          - source_labels: [__meta_dns_name]
            target_label: k8s_service
          - target_label: environment
            replacement: "production"

      # -----------------------------------------------------------------
      # 4. GitHub Actions Exporter
      # -----------------------------------------------------------------
      - job_name: "github-actions"
        scrape_interval: 30s
        static_configs:
          - targets: ["github-actions-exporter:9101"]

  alert_rules.yml: |
    groups:
      - name: host_alerts
        rules:
          - alert: HighCpuUsage
            expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ $labels.instance }}"

          - alert: HighMemoryUsage
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ $labels.instance }}"

          - alert: InstanceDown
            expr: up == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Instance {{ $labels.instance }} is down"

          - alert: NodeExporterDown
            expr: up{job="node-exporter"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Node Exporter down on {{ $labels.node_name }}"

      - name: nextjs_app_alerts
        rules:
          - alert: NextJsAppMetricsDown
            expr: up{job="nextjs-application-metrics"} == 0
            for: 3m
            labels:
              severity: warning
            annotations:
              summary: "Next.js /api/metrics endpoint unreachable"

          - alert: NextJsHighErrorRate
            expr: |
              (
                sum(rate(http_requests_total{job="nextjs-application-metrics", status_code=~"5.."}[5m]))
                /
                sum(rate(http_requests_total{job="nextjs-application-metrics"}[5m]))
              ) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High 5xx error rate on Next.js"

          - alert: NextJsHighLatency
            expr: |
              histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="nextjs-application-metrics"}[5m])) by (le))
              > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High p95 latency on Next.js"
