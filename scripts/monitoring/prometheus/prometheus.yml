global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: "ec2-monitoring"

alerting:
  alertmanagers:
    - static_configs:
        - targets: []

rule_files:
  - /etc/prometheus/alert_rules.yml

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
        labels:
          environment: "production"
          instance_name: "monitoring-host"

  # Next.js ECS node-exporter metrics via EC2 service discovery
  - job_name: "ecs-nextjs-node-exporter"
    ec2_sd_configs:
      - region: eu-west-1
        port: 9100
        filters:
          - name: tag:Purpose
            values: ["NextJS"]
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance_name
      - source_labels: [__meta_ec2_tag_Environment]
        target_label: environment
      - source_labels: [__meta_ec2_instance_id]
        target_label: instance_id
      - source_labels: [__meta_ec2_availability_zone]
        target_label: availability_zone

  # Next.js application metrics via Cloud Map DNS service discovery
  # Uses dns_sd_configs because Next.js tasks use awsvpc networking
  # (task ENI IPs ≠ host IP — ec2_sd_configs would resolve to host, not container)
  # Cloud Map registers each task's ENI IP as an A record under nextjs.local
  - job_name: "nextjs-application-metrics"
    metrics_path: "/api/metrics"
    scrape_interval: 30s
    authorization:
      type: Bearer
      credentials_file: /etc/prometheus/secrets/metrics-token
    dns_sd_configs:
      - names:
          - "nextjs-app.nextjs.local"
        type: A
        port: 3000
        refresh_interval: 30s
    relabel_configs:
      - source_labels: [__meta_dns_name]
        target_label: cloudmap_service
      - target_label: environment
        replacement: "production"

  # GitHub Actions workflow run metrics (via github-actions-exporter)
  - job_name: "github-actions"
    scrape_interval: 30s
    static_configs:
      - targets: ["github-actions-exporter:9101"]
