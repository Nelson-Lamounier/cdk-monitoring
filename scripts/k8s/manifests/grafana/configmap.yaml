# @format
# Grafana ConfigMap â€” datasources and dashboard providers
# Ported from scripts/monitoring/grafana/provisioning/
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-provisioning
  namespace: monitoring
  labels:
    app: grafana
    app.kubernetes.io/part-of: monitoring
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false

      - name: Loki
        type: loki
        uid: loki
        access: proxy
        url: http://loki:3100
        isDefault: false
        editable: false
        jsonData:
          maxLines: 1000

      - name: CloudWatch
        type: cloudwatch
        uid: cloudwatch
        access: proxy
        isDefault: false
        editable: false
        jsonData:
          authType: default
          defaultRegion: eu-west-1

      - name: Tempo
        type: tempo
        uid: tempo
        access: proxy
        url: http://tempo:3200
        isDefault: false
        editable: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            filterByTraceID: true
            filterBySpanID: true
          tracesToMetrics:
            datasourceUid: prometheus
          serviceMap:
            datasourceUid: prometheus
          nodeGraph:
            enabled: true
          lokiSearch:
            datasourceUid: loki

      - name: Steampipe
        type: postgres
        uid: steampipe
        access: proxy
        url: steampipe:9193
        user: steampipe
        isDefault: false
        editable: false
        jsonData:
          database: steampipe
          sslmode: disable
          maxOpenConns: 5
          maxIdleConns: 2
          postgresVersion: 1400
        secureJsonData:
          password: steampipe

  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: "default"
        orgId: 1
        folder: ""
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards
