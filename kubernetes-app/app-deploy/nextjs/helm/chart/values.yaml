# @format
# Default values for the nextjs-app Helm chart.
# Override per-environment via nextjs-values.yaml.

namespace: nextjs-app

# ---------------------------------------------------------------------------
# Application Image
# ---------------------------------------------------------------------------
image:
  repository: "" # Overridden at deploy time via --set image.repository=<ECR_URI>
  tag: latest
  pullPolicy: Always

# ---------------------------------------------------------------------------
# Deployment
# ---------------------------------------------------------------------------
replicas: 2
port: 3000

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Security context for the pod
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001

# Security context for the container
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false # Next.js needs writable .next/cache

# ---------------------------------------------------------------------------
# Node Placement
# ---------------------------------------------------------------------------
nodeSelector:
  role: application

# ---------------------------------------------------------------------------
# Service
# ---------------------------------------------------------------------------
service:
  type: ClusterIP
  port: 3000

# ---------------------------------------------------------------------------
# Health Probes
# ---------------------------------------------------------------------------
probes:
  readiness:
    path: /api/health
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  liveness:
    path: /api/health
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

# ---------------------------------------------------------------------------
# Horizontal Pod Autoscaler
# ---------------------------------------------------------------------------
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilization: 70

# ---------------------------------------------------------------------------
# Ingress (Traefik IngressRoute CRD)
# ---------------------------------------------------------------------------
ingress:
  enabled: true
  # Match all hosts — CloudFront handles domain routing
  matchRule: "PathPrefix(`/`)"

# ---------------------------------------------------------------------------
# Secrets (injected via deploy.py → Kubernetes Secret)
# ---------------------------------------------------------------------------
secrets:
  name: nextjs-secrets

# ---------------------------------------------------------------------------
# Resource Quota (namespace-level limits)
# ---------------------------------------------------------------------------
resourceQuota:
  hard:
    requests.cpu: "1"
    requests.memory: 1Gi
    limits.cpu: "2"
    limits.memory: 2Gi
    persistentvolumeclaims: "2"

# ---------------------------------------------------------------------------
# Network Policy
# ---------------------------------------------------------------------------
networkPolicy:
  enabled: true
