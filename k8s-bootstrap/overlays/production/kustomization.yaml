# @format
# Production Overlay
#
# Patches for production environment:
# - 2 replicas (high availability)
# - Higher resource limits
# - Monitoring node: Spot, Application node: Reserved (anticipated in CDK)
# - Production-specific OTEL attributes
# - Stricter deployment strategy

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../apps/nextjs

patches:
  # Deployment: production overrides
  - target:
      kind: Deployment
      name: nextjs
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nextjs
      spec:
        replicas: 2
        strategy:
          type: RollingUpdate
          rollingUpdate:
            maxUnavailable: 0
            maxSurge: 1
        template:
          spec:
            containers:
              - name: nextjs
                resources:
                  requests:
                    cpu: 256m
                    memory: 512Mi
                  limits:
                    cpu: 512m
                    memory: 1Gi
              - name: alloy
                resources:
                  requests:
                    cpu: 32m
                    memory: 64Mi
                  limits:
                    cpu: 64m
                    memory: 128Mi
            # Ensure pods spread across nodes for HA (when multi-node)
            topologySpreadConstraints:
              - maxSkew: 1
                topologyKey: kubernetes.io/hostname
                whenUnsatisfiable: ScheduleAnyway
                labelSelector:
                  matchLabels:
                    app: nextjs

  # HPA: production scale
  - target:
      kind: HorizontalPodAutoscaler
      name: nextjs
    patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: nextjs
      spec:
        minReplicas: 2
        maxReplicas: 5

  # ConfigMap: production OTEL attributes
  - target:
      kind: ConfigMap
      name: nextjs-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: nextjs-config
      data:
        OTEL_RESOURCE_ATTRIBUTES: "environment=production,service.namespace=nextjs"
